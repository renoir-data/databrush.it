---
import PageLayout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import Features from '~/components/widgets/Features.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import dashboardImage from '~/assets/images/dashboard.png';
import * as m from '~/paraglide/messages';
import { getLanguagePaths } from '~/lib/i18n';
import { getRelativeLocaleUrl } from 'astro:i18n';

export function getStaticPaths() {
  return getLanguagePaths();
}

const metadata = {
  title: m.dashboard_page_title(),
};

const lang = Astro.currentLocale || Astro.preferredLocale || 'en';
---

<PageLayout metadata={metadata}>
  <div class="min-h-screen flex items-center justify-center">
    <Hero actions={[{ text: m.dashboard_hero_action(), href: getRelativeLocaleUrl(lang, '/contact'), variant: 'primary' }]}>
      <Fragment slot="title">{m.dashboard_page_title()}</Fragment>
      <Fragment slot="subtitle">{m.dashboard_hero_subtitle()}</Fragment>
    </Hero>
  </div>

  <section class="relative lg:block h-[400vh]">
    <div class="sticky top-0 h-screen flex items-center justify-center">
      <div class="relative h-[80%] mt-10">
        <video id="dashboard-video" muted playsinline class="w-full h-full object-cover rounded-md shadow-lg z-10">
          <source src={m.dashboard_video_src()} type="video/mp4" />
          {m.video_alt_text()}
        </video>

        <!-- Time-synced labels overlay -->
        <div id="sales-overlay" class="pointer-events-none absolute inset-0 z-20">
          <div
            class="transition-opacity duration-500 opacity-0 absolute top-[40%] left-[105%]"
            data-start="0.0"
            data-end="5.0"
            aria-hidden="true"
          >
            <div class="bg-black/60 text-white text-sm md:text-base px-3 py-2 rounded-md shadow">
              {m.dashboard_label_1()}
            </div>
            <svg
              class="absolute top-1/2 -left-8 w-8 h-8 text-white rotate-180"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
          </div>
          <div
            class="transition-opacity duration-500 opacity-0 absolute top-[20%] right-[105%]"
            data-start="5.0"
            data-end="10.0"
            aria-hidden="true"
          >
            <div class="bg-black/60 text-white text-sm md:text-base px-3 py-2 rounded-md shadow">
              {m.dashboard_label_2()}
            </div>
            <!-- Arrow pointing to center-right of video -->
            <svg class="absolute top-1/2 -right-8 w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </div>
          <div
            class="transition-opacity duration-500 opacity-0 absolute top-[30%] right-[105%]"
            data-start="10.0"
            data-end="15.0"
            aria-hidden="true"
          >
            <div class="bg-black/60 text-white text-sm md:text-base px-3 py-2 rounded-md shadow">
              {m.dashboard_label_3()}
            </div>
            <!-- Arrow pointing to center-right of video -->
            <svg class="absolute top-1/2 -right-8 w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const video = document.getElementById('dashboard-video') as HTMLVideoElement | null;
        const overlay = document.getElementById('sales-overlay') as HTMLElement | null;
        if (!video || !overlay) return;
        const vid = video as HTMLVideoElement; // narrow non-null after guard

        // Respect reduced motion preferences: don't autoplay in this case.
        const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        // Intersection-based autoplay: play only when fully visible.
        const io = new IntersectionObserver(
          (entries) => {
            for (const entry of entries) {
              const fullyVisible = entry.intersectionRatio >= 0.99; // approx fully visible
              if (!prefersReducedMotion && fullyVisible) {
                const p = vid.play();
                if (p && typeof p.catch === 'function') p.catch(() => {});
              } else {
                try {
                  vid.pause();
                } catch (_) {}
              }
            }
          },
          { threshold: [0, 0.25, 0.5, 0.75, 0.99, 1] }
        );
        io.observe(vid);

        // Pause when tab is hidden; resume via IO when visible again
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            try {
              vid.pause();
            } catch (_) {}
          }
        });

        // Label sync logic
        const labels = Array.from(overlay.querySelectorAll('[data-start][data-end]')) as HTMLElement[];
        function syncLabels() {
          const t = vid.currentTime || 0;
          for (const el of labels) {
            const start = parseFloat(el.getAttribute('data-start') || '0');
            const end = parseFloat(el.getAttribute('data-end') || '0');
            const visible = t >= start && t <= end;
            // toggle opacity class
            el.classList.toggle('opacity-0', !visible);
            el.classList.toggle('opacity-100', visible);
            el.setAttribute('aria-hidden', String(!visible));
          }
        }

        // Ensure we start with correct state after metadata loads
        vid.addEventListener('loadedmetadata', syncLabels, { passive: true });
        vid.addEventListener('timeupdate', syncLabels, { passive: true });
        vid.addEventListener('seeked', syncLabels, { passive: true });
        vid.addEventListener(
          'emptied',
          () => {
            for (const el of labels) {
              el.classList.remove('opacity-100');
              el.classList.add('opacity-0');
              el.setAttribute('aria-hidden', 'true');
            }
          },
          { passive: true }
        );

        // Initialize once DOM is ready
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          syncLabels();
        } else {
          document.addEventListener('DOMContentLoaded', syncLabels, { once: true, passive: true });
        }
      })();
    </script>
  </section>

  <section class="max-w-6xl mx-auto px-4 sm:px-6 py-12">
    <Features
      title={m.dashboard_features_title()}
      subtitle={m.dashboard_features_subtitle()}
      columns={2}
      items={[
        {
          title: m.dashboard_feature_1_title(),
          description: m.dashboard_feature_1_description(),
          icon: 'tabler:chart-line',
        },
        {
          title: m.dashboard_feature_2_title(),
          description: m.dashboard_feature_2_description(),
          icon: 'tabler:alert-triangle',
        },
        {
          title: m.dashboard_feature_3_title(),
          description: m.dashboard_feature_3_description(),
          icon: 'tabler:bell',
        },
        {
          title: m.dashboard_feature_4_title(),
          description: m.dashboard_feature_4_description(),
          icon: 'tabler:cloud',
        },
      ]}
    />

    <Features
      title={m.dashboard_use_cases_title()}
      subtitle={m.dashboard_use_cases_subtitle()}
      columns={3}
      items={[
        {
          title: m.dashboard_use_case_1_title(),
          description: m.dashboard_use_case_1_description(),
          icon: 'tabler:robot',
        },
        {
          title: m.dashboard_use_case_2_title(),
          description: m.dashboard_use_case_2_description(),
          icon: 'tabler:bolt',
        },
        {
          title: m.dashboard_use_case_3_title(),
          description: m.dashboard_use_case_3_description(),
          icon: 'tabler:truck',
        },
      ]}
      defaultIcon="tabler:check"
    />

    <div class="mt-8">
      <CallToAction
        actions={[
          {
            text: m.dashboard_hero_action(),
            href: getRelativeLocaleUrl(lang, '/contact'),
            variant: 'primary',
          },
        ]}
      >
        <Fragment slot="title">{m.dashboard_cta_title()}</Fragment>
        <Fragment slot="subtitle">{m.dashboard_cta_subtitle()}</Fragment>
      </CallToAction>
    </div>
  </section>
</PageLayout>
