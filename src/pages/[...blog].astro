---
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';

import { getCanonical, getPermalink } from '~/utils/permalinks';
import { fetchPosts, blogPostRobots } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';

export const prerender = false;

// Get the blog slug from the URL
const blogSlug = Astro.params.blog;

// Find the post by permalink
const allPosts = await fetchPosts();
const post = allPosts.find(p => p.permalink === blogSlug);

if (!post) {
  return Astro.redirect('/blog');
}

const url = getCanonical(getPermalink(post.permalink, 'post'));
const image = await findImage(post.image);

const metadata: MetaData = {
  title: post.title,
  description: post.excerpt,
  robots: {
    index: blogPostRobots?.index,
    follow: blogPostRobots?.follow,
  },
};
---

<Layout metadata={metadata}>
  <SinglePost post={{ ...post, image: image }} url={url}>
    {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
  </SinglePost>
  <ToBlogLink />
  <RelatedPosts post={post} />
</Layout>